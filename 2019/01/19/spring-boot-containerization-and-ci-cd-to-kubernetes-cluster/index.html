<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&family=Noto+Sans+Mono">
  
  <title>
    
    스프링 부트 컨테이너와 CI/CD 환경 구성하기 |
    
    Eric Han&#39;s IT Blog
  </title>
  <link rel="canonical" href="https://futurecreator.github.io/2019/01/19/spring-boot-containerization-and-ci-cd-to-kubernetes-cluster/">
  
  
  <link rel="icon" href="/images/favicions/favicon6.png">
  
  
<link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">

  
<link rel="stylesheet" href="/vendor/score-dream/css/styles.css">

  
<link rel="stylesheet" href="/css/style.css">

  
<script src="/vendor/jquery/2.0.3/jquery.min.js"></script>

  


<link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css">




<link rel="stylesheet" href="/vendor/scrollLoading/style.css">



<script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-79199094-2', 'auto');
ga('send', 'pageview');

</script>



  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2948714191026958" crossorigin="anonymous"></script>
  <meta name="naver-site-verification" content="3b37509fddeb6247d17fb82c1e7fc2c2b51417d1">
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/feed.xml" title="Eric Han's IT Blog" type="application/atom+xml">
</head>
<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                        <li class="main-nav-list-item">
                                            <a class="main-nav-list-link" href="/">
                                                Home
                                            </a>
                                        </li>
                                        
                                <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/AI/">AI</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Cloud/">Cloud</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Hexo/">Hexo</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/">Programming</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/Algorithm/">Algorithm</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/Apple/">Apple</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/Column/">Column</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/Java/">Java</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/JavaScript/">JavaScript</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/MSA/">MSA</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/Spark/">Spark</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/Vert-x/">Vert.x</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Programming/Web/">Web</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Reviews/">Reviews</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Science/">Science</a></li></ul>
                                    
                                        <li class="main-nav-list-item">
                                            <a class="main-nav-list-link" href="/about">
                                                About
                                            </a>
                                        </li>
                                        
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Cloud/">Cloud</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-spring-boot-containerization-and-ci-cd-to-kubernetes-cluster" class="article article-single article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
    
        <h1 class="article-title" itemprop="name">
        스프링 부트 컨테이너와 CI/CD 환경 구성하기
        </h1>
    

      </header>
      
        <div class="article-subtitle">
          🗓
          <a href="/2019/01/19/spring-boot-containerization-and-ci-cd-to-kubernetes-cluster/" class="article-date">
    <time datetime="2019-01-19T08:40:16.000Z" itemprop="datePublished">2019/01/19</time>
</a>
            <span class="reading-time">⏰ 소요시간
              1:13
            </span>
        </div>

        <div class="article-entry" itemprop="articleBody">
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>이번 포스트에서는 간단한 스프링 부트(Spring Boot) 애플리케이션을 만들고 컨테이너화(Containerize)하는 방법을 알아봅니다. 그리고 다양한 툴을 이용해 도커 이미지를 지속적으로 빌드하고 배포할 수 있는 CI/CD 환경을 구성하고 쿠버네티스(Kubernetes) 클러스터에 배포하는 과정을 살펴봅니다.</p>
<p>살펴볼 내용은 다음과 같습니다.</p>
<ul>
<li>컨테이너화 Containerization</li>
<li>스프링 부트 컨테이너화하기</li>
<li>도커 이미지 기반 CI/CD 환경 구성하기</li>
<li>첫 번째 환경: Google Cloud Build</li>
<li>두 번째 환경: GitLab + GKE</li>
<li>정리</li>
</ul>
<h2 id="컨테이너화-Containerization">컨테이너화 Containerization</h2>
<p><img src="virtual-machine-vs-container.png" alt="가상 머신과 컨테이너 비교"></p>
<p>컨테이너화는 애플리케이션을 컨테이너로 감싸는 작업을 말합니다. 컨테이너는 가상 머신(Virtual Machine)과는 다르게 게스트 OS 없이 호스트 OS 의 자원을 공유하므로 더 빠르고 리소스 사용이 효율적인 가상화 방식입니다. 이번 포스트에서는 대표적인 가상화 SW인 도커(Docker)로 컨테이너를 만듭니다. 도커로 애플리케이션과 해당 실행 환경을 감싸면 이미지 형태로 빌드할 수 있습니다. 따라서 도커만 설치되어 있으면 어디든 동일한 환경에서 애플리케이션을 실행할 수 있으므로 개발 및 배포, 운영 시 매우 용이합니다.</p>
<p>가상화와 도커에 대한 자세한 내용은 다음 포스트를 참고하세요.</p>
<ul>
<li>
<a href="/2018/11/09/it-infrastructure-basics/" title="개발자를 위한 인프라 기초 총정리">개발자를 위한 인프라 기초 총정리</a>
</li>
<li>
<a href="/2018/11/16/docker-container-basics/" title="도커 Docker 기초 확실히 다지기">도커 Docker 기초 확실히 다지기</a>
</li>
</ul>
<h2 id="스프링-부트-컨테이너화하기">스프링 부트 컨테이너화하기</h2>
<p>먼저 스프링 부트 애플리케이션을 만들고 컨테이너화 해봅시다.</p>
<h3 id="환경-준비">환경 준비</h3>
<p>실습에 사용할 리눅스 머신이 필요합니다. Mac, 가상 머신, AWS EC2 등 원하는 환경을 준비합니다. 이번 포스트에서는 로컬 환경에서 간단하게 VM을 사용할 수 있는  <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.virtualbox.org">VirtualBox</a> 와 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.vagrantup.com">Vagrant</a> 로 실습 환경을 구성합니다. VirtualBox 는 VM을 만들고, Vagrant 는 VM 이미지와 설정 파일(<code>Vagrantfile</code>)로 가상 머신을 쉽게 설정하고 찍어낼 수 있습니다. 두 SW 를 설치한 후 실습을 진행합니다.</p>
<p>원하는 경로에 폴더를 만들고 초기화합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant init</span><br><span class="line">A `Vagrantfile` has been placed <span class="keyword">in</span> this directory. You are now</span><br><span class="line">ready to `vagrant up` your first virtual environment! Please <span class="built_in">read</span></span><br><span class="line">the comments <span class="keyword">in</span> the Vagrantfile as well as documentation on</span><br><span class="line">`vagrantup.com` <span class="keyword">for</span> more information on using Vagrant.</span><br></pre></td></tr></table></figure>
<p>생성된 <code>Vagrantfile</code> 을 수정합니다.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vagrant</span>.configure(<span class="string">&quot;2&quot;</span>) <span class="keyword">do</span> |<span class="params">config</span>|</span><br><span class="line">  config.vm.box = <span class="string">&quot;centos/7&quot;</span></span><br><span class="line">  config.vm.network <span class="string">&quot;forwarded_port&quot;</span>, <span class="symbol">guest:</span> <span class="number">80</span>, <span class="symbol">host:</span> <span class="number">8000</span></span><br><span class="line">  config.vm.network <span class="string">&quot;private_network&quot;</span>, <span class="symbol">ip:</span> <span class="string">&quot;192.168.33.10&quot;</span></span><br><span class="line">  config.vm.synced_folder <span class="string">&quot;.&quot;</span>, <span class="string">&quot;/vagrant&quot;</span>, <span class="symbol">disabled:</span> <span class="literal">true</span></span><br><span class="line">  config.vm.provision <span class="string">&quot;docker&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>config.vm.box</code>: 가상 환경에서 사용할 박스 이미지를 설정합니다. CentOS 7을 사용합니다. <a target="_blank" rel="external nofollow noopener noreferrer" href="https://app.vagrantup.com/boxes/search">Vagrant Cloud</a> 에서 원하는 박스 이미지를 검색할 수 있습니다.</li>
<li><code>config.vm.network &quot;forwarded_port&quot;</code>: 게스트의 <code>80</code>과 호스트의 <code>8000</code> 포트를 연결합니다.</li>
<li><code>config.vm.network &quot;forwarded_port&quot;</code>: 게스트의 <code>80</code>과 호스트의 <code>8000</code> 포트를 연결합니다.</li>
<li><code>config.vm.provision &quot;docker&quot; </code>: 도커를 자동으로 설치합니다. 따라서 VM에 따로 도커를 설치할 필요가 없습니다.</li>
</ul>
<p><code>vagrant up</code> 으로 VM 을 실행합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vagrant up</span><br><span class="line">Bringing machine <span class="string">&#x27;default&#x27;</span> up with <span class="string">&#x27;virtualbox&#x27;</span> provider...</span><br><span class="line">==&gt; default: Importing base box <span class="string">&#x27;centos/7&#x27;</span>...</span><br><span class="line">==&gt; default: Matching MAC address <span class="keyword">for</span> NAT networking...</span><br><span class="line">==&gt; default: Checking <span class="keyword">if</span> box <span class="string">&#x27;centos/7&#x27;</span> is up to <span class="built_in">date</span>...</span><br><span class="line">==&gt; default: A newer version of the box <span class="string">&#x27;centos/7&#x27;</span> <span class="keyword">for</span> provider <span class="string">&#x27;virtualbox&#x27;</span> is</span><br><span class="line">==&gt; default: available! You currently have version <span class="string">&#x27;1811.02&#x27;</span>. The latest is version</span><br><span class="line">==&gt; default: <span class="string">&#x27;1812.01&#x27;</span>. Run `vagrant box update` to update.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>vagrant ssh</code> 로 VM에 SSH 접속할 수 있습니다. 접속 후에는  <code>sudo su -</code> 를 이용해 root 로 접속할 수 있습니다.</p>
<p>마지막으로 실습을 편하게 진행하기 위해 Java 와 Git 도 설치합시다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> su -</span><br><span class="line">yum update -y</span><br><span class="line">yum install -y java-1.8.0-openjdk-devel.x86_64</span><br><span class="line">yum install -y git</span><br></pre></td></tr></table></figure>
<p>이제 Docker, Java, Git이 설치된 VM 을 사용할 수 있습니다.</p>
<h3 id="스프링-부트-애플리케이션-만들기">스프링 부트 애플리케이션 만들기</h3>
<p>실습에 사용할 간단한 스프링 부트 애플리케이션을 작성합니다. <a target="_blank" rel="external nofollow noopener noreferrer" href="https://start.spring.io">Spring Initializr</a> 로 프로젝트를 만들면 필요한 초기 설정을 쉽게 구성할 수 있습니다.<br>
<img src="spring-initializr.png" alt="Spring Initalizr로 프로젝트 만들기"><br>
위 그림과 같이 설정한 후 <strong>Generate Project</strong> 로 생성된 압축 파일을 다운로드합니다.</p>
<p>압축 파일을 풀고 해당 폴더에서 <code>mvnw spring-boot:run</code>으로 바로 실행해봅시다. 여기선 maven 을 사용하지만 gradle 을 사용해도 좋습니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./mvnw spring-boot:run</span><br><span class="line">[INFO] Scanning <span class="keyword">for</span> projects...</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] ----------------------&lt; com.docker.example:hello &gt;----------------------</span><br><span class="line">[INFO] Building hello 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] --------------------------------[ jar ]---------------------------------</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] &gt;&gt;&gt; spring-boot-maven-plugin:2.1.1.RELEASE:run (default-cli) &gt; test-compile @ hello &gt;&gt;&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>controller</code> 패키지를 만들고 <code>/</code> 요청을 받을 <code>HelloController</code> 를 만듭니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.docker.example.hello.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello, Docker!&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>pom.xml</code> 파일에 플러그인 설정을 추가합니다. 해당 설정이 없으면 VM 이나 컨테이너 환경에서 빌드(테스트) 시 에러가 발생합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">useSystemClassLoader</span>&gt;</span>false<span class="tag">&lt;/<span class="name">useSystemClassLoader</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>Vagrantfile</code> 에 파일을 옮기는 설정을 추가합니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.vm.provision &quot;file&quot;, source: &quot;./hello&quot;, destination: &quot;$HOME/hello&quot;</span><br></pre></td></tr></table></figure>
<p>Vagrant 를 프로비저닝해서 소스를 옮깁니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant up</span><br></pre></td></tr></table></figure>
<p>환경과 소스를 모두 준비했습니다.</p>
<h3 id="컨테이너로-감싸기">컨테이너로 감싸기</h3>
<p>이제 해당 애플리케이션을 감싸기 위한 실행 환경을 정의합니다. 이를 <code>Dockerfile</code> 에 정의합니다.</p>
<p><code>Dockerfile</code> 을 작성합니다.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jre-alpine</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/*.jar app.jar</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>도커는 베이스 이미지(<code>FROM</code>)를 기반으로 설정한 항목을 수행하면서 변경 사항을 이미지 레이어로 저장합니다.</p>
<ul>
<li><code>FROM</code>: 가벼운 리눅스인 alpine 에 openjdk 8 이 설치된 이미지입니다.</li>
<li><code>COPY</code>: 컨테이너 안으로 파일을 복사합니다.</li>
<li><code>ENTRYPOINT</code>: 컨테이너를 실행할 때 수행할 명령어 입니다.</li>
</ul>
<p>먼저 메이븐 빌드를 수행합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw install</span><br></pre></td></tr></table></figure>
<p>도커 이미지를 빌드합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t myorg/myapp .</span><br></pre></td></tr></table></figure>
<p>그러면 <code>myorg/myapp</code> 이라는 태그가 달린 이미지가 생성됩니다.</p>
<p>도커 이미지를 실행합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8000:8080 myorg/myapp</span><br><span class="line">a6a7955807288a90943b95b5520466e66d7de3ff2bee07a611627fba85c1aae8</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-d</code> : 백그라운드에서 실행합니다.</li>
<li><code>-p</code> : <code>&lt;호스트 포트&gt;:&lt;컨테이너 포트&gt;</code> 형식으로 작성합니다.</li>
<li><code>a6a795580728</code>: 실행 시 해당 컨테이너 ID가 출력됩니다.</li>
</ul>
<p>도커가 실행되는 컨테이너를 확인합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">a6a795580728        myorg/myapp         <span class="string">&quot;java -jar /app.jar&quot;</span>   5 seconds ago       Up 4 seconds        0.0.0.0:8000-&gt;8080/tcp   silly_merkle</span><br></pre></td></tr></table></figure>
<p>접속을 확인해봅시다. 고정 IP로 설정한 <code>http://192.168.33.10:8000</code> 로 접속하면 화면을 볼 수 있습니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8000</span><br><span class="line">Hello, Docker!</span><br></pre></td></tr></table></figure>
<p>컨테이너 내부로 들어가면 <code>app.jar</code> 를 확인할 수 있습니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --entrypoint /bin/sh myorg/myapp</span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">app.jar  dev      home     media    proc     run      srv      tmp      var</span><br><span class="line">bin      etc      lib      mnt      root     sbin     sys      usr</span><br></pre></td></tr></table></figure>
<h3 id="Dockerfile-개선하기">Dockerfile 개선하기</h3>
<p>스프링 애플리케이션을 아주 쉽게 컨테이너로 만들었습니다. 하지만 지금 이미지는 조금 비효율적입니다. 도커가 이미지를 만드는 방식과 관련이 있습니다.</p>
<p>도커는 이미지를 빌드하는 과정을 이미지를 여러 겹의 레이어로 구성하고, 수정이 있는 레이어만 다시 작업합니다. 나머지 수정이 없는 레이어는 캐시해놓은 것을 사용하기 때문에 빠르게 빌드할 수 있습니다. 하지만 우리 JAR 파일 안에는 각종 디펜던시가 함께 들어가 있기 때문에 도커 이미지에는 하나의 레이어만 생성되고, 애플리케이션이 수정될 때마다 해당 레이어가 변경됩니다.</p>
<p>다음은 이미지의 레이어를 <code>docker inspect</code> 명령어로 확인한 모습입니다. 마지막 레이어가 우리 애플리케이션의 레이어입니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;Layers&quot;: [</span><br><span class="line">&quot;sha256:7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8&quot;,</span><br><span class="line">&quot;sha256:dbc783c89851d29114fb01fd509a84363e2040134e45181354051058494d2453&quot;,</span><br><span class="line">&quot;sha256:382d47ad6dc1ef98fc8d97372af64fc4f06c39de5edb9d6ba5a3315ce87def51&quot;,</span><br><span class="line">&quot;sha256:d180830db04728775d84bc906de568cb552bbfce823e835168c6e63b7905db4f&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>이제 하나로 구성된 레이어를 여러 개의 레이어로 나눠봅시다.</p>
<p>먼저 디펜던시를 각각 복사할 수 있도록 폴더를 생성하고 JAR 압축을 풉니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> target/dependency</span><br><span class="line"><span class="built_in">cd</span> target/dependency</span><br><span class="line">jar -xvf ../*.jar</span><br></pre></td></tr></table></figure>
<p><code>Dockerfile</code> 을 수정합니다. 각 디펜던시를 <code>COPY</code> 하는 작업이 하나의 레이어가 됩니다.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jre-alpine</span><br><span class="line"><span class="keyword">ARG</span> DEPENDENCY=target/dependency</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;DEPENDENCY&#125;</span>/BOOT-INF/lib /app/lib</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;DEPENDENCY&#125;</span>/META-INF /app/META-INF</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;DEPENDENCY&#125;</span>/BOOT-INF/classes /app</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-cp&quot;</span>,<span class="string">&quot;app:app/lib/*&quot;</span>,<span class="string">&quot;com.docker.example.hello.HelloApplication&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>다시 도커 이미지를 빌드합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t myorg/myapp .</span><br></pre></td></tr></table></figure>
<p>이미지를 확인해보면 레이어가 늘어난 것을 확인할 수 있습니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;Layers&quot;: [</span><br><span class="line">&quot;sha256:7bff100f35cb359a368537bb07829b055fe8e0b1cb01085a3a628ae9c187c7b8&quot;,</span><br><span class="line">&quot;sha256:dbc783c89851d29114fb01fd509a84363e2040134e45181354051058494d2453&quot;,</span><br><span class="line">&quot;sha256:382d47ad6dc1ef98fc8d97372af64fc4f06c39de5edb9d6ba5a3315ce87def51&quot;,</span><br><span class="line">&quot;sha256:b1d7f7bd343054042f9c7f2847822f97749b14541f867137a53aca86e68f5d41&quot;,</span><br><span class="line">&quot;sha256:c40aca1731d0acd8b9b885b5196e2bc0e697eee03f03322fb91cb6ec5ab4816f&quot;,</span><br><span class="line">&quot;sha256:c2d77979785785ac75e5151e80679c91299a08b7e3f24d2dd0a1914fa26741cd&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>이 방법은 압축을 해제하는 과정이 필요하므로, 이후 실습에서는 편의를 위해 첫 번째 방법으로 진행합니다.</p>
<h2 id="도커-이미지-기반-CI-CD-환경-구성하기">도커 이미지 기반 CI/CD 환경 구성하기</h2>
<p>이번에는 코드를 관리하고 도커 이미지 기반의 CI/CD 환경을 구성해봅시다.</p>
<h3 id="구성-요소">구성 요소</h3>
<ol>
<li>코드와 <code>Dockerfile</code> 을 함께 관리하고 CI 서버를 이용해 코드가 푸시될 때마다 해당 코드를 도커 이미지로 빌드합니다.</li>
<li>빌드한 이미지는 이미지 레지스트리(Image Registry)에 따로 저장해서 보관합니다.</li>
<li>빌드한 이미지를 컨테이너로 쿠버네티스(Kubernetes) 클러스터에 배포합니다.</li>
</ol>
<p>필요한 구성 요소는 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>도구</th>
<th>서비스</th>
</tr>
</thead>
<tbody>
<tr>
<td>소스 코드 관리</td>
<td><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com">GitHub</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://gitlab.com">GitLab</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://aws.amazon.com/ko/codestar/">AWS CodeStar</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://cloud.google.com/source-repositories/">Google Cloud Source Repository</a>, etc.</td>
</tr>
<tr>
<td>코드를 push 할 때마다 자동으로 빌드하고 배포할 CI/CD 파이프라인</td>
<td><a target="_blank" rel="external nofollow noopener noreferrer" href="https://aws.amazon.com/ko/codepipeline/">AWS CodePipeline</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://cloud.google.com/cloud-build/">Google Cloud Build</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://about.gitlab.com/product/continuous-integration/">GitLab CI/CD</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://jenkins.io">Jenkins</a>, etc.</td>
</tr>
<tr>
<td>빌드한 이미지를 저장할 프라이빗 도커 레지스트리(Private Docker Registry)</td>
<td><a target="_blank" rel="external nofollow noopener noreferrer" href="https://aws.amazon.com/ko/ecr/">Amazon Elastic Container Registry</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://cloud.google.com/container-registry/">Google Container Registry</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.gitlab.com/ee/user/project/container_registry.html">GitLab Container Registry</a>, etc.</td>
</tr>
<tr>
<td>빌드 결과를 배포할 쿠버네티스(Kubernetes) 클러스터</td>
<td><a target="_blank" rel="external nofollow noopener noreferrer" href="https://cloud.google.com/kubernetes-engine/">Google Kubernetes Engine</a>, <a target="_blank" rel="external nofollow noopener noreferrer" href="https://aws.amazon.com/ko/eks/">Amazon Elastic Container Service for Kubernetes</a>, etc.</td>
</tr>
</tbody>
</table>
<p>이를 구성하는 방법은 여러가지가 있습니다. 이번 포스트에서는 다양한 시나리오를 살펴보기 위해 다음과 같이 세 가지 방법으로 구성해보겠습니다.</p>
<ul>
<li>Google Cloud Build</li>
<li>GCP와 Dockerfile</li>
<li>GItLab + GKE</li>
</ul>
<h3 id="쿠버네티스-Kubernetes">쿠버네티스 Kubernetes</h3>
<p><img src="kubernetes.png" alt="https://kubernetes.io"></p>
<p>도커 컨테이너는 도커만 설치되어 있으면 동작합니다. 하지만 분산 환경에서 많은 컨테이너를 관리하는 것은 쉽지 않습니다. 따라서 주로 도커 컨테이너를 그냥 사용하기보다는 쿠버네티스라는 컨테이너 플랫폼 위에서 실행합니다.</p>
<p>쿠버네티스는 분산 환경의 많은 컨테이너를 쉽게 관리할 수 있는 오케스트레이션(Orchestration) 툴로 알려져 있습니다. 하지만 쿠버네티스는 단순한 오케스트레이션 툴을 넘어 하나의 플랫폼으로 빠르게 발전했습니다. 이제는 많은 기업들이 컨테이너 운영 환경에 쿠버네티스를 도입해 사용하고 있습니다. 자세한 내용은 이후 쿠버네티스 관련 포스트에서 따로 다루도록 하겠습니다.</p>
<ul>
<li>여러 노드를 하나의 노드처럼 관리</li>
<li>노드의 부하를 확인해 컨테이너를 어디에 배포할 지 스케쥴링(scheduling)</li>
<li>컨테이너의 상태를 체크해 자동 복구(self healing)</li>
<li>부하에 따라 오토 스케일링(auto scaling)</li>
</ul>
<p>쿠버네티스는 구글에서 시작된 오픈소스로, 구글의 15년 이상의 컨테이너 운영 경험이 녹아 있습니다. Google Kubernetes Engine 은 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://cloud.google.com">Google Cloud Platform</a> 에서 제공하는 완전관리형(fully-managed) 쿠버네티스 클러스터로 Google SRE 가 관리하며 쿠버네티스의 최신 버전을 자동으로 적용하기 때문에 다른 관리 없이 편하게 사용이 가능합니다.</p>
<p>이번 포스트는 쿠버네티스 클러스터를 구성하고 관리하는 것이 목적이 아니므로 GKE 로 애플리케이션을 배포하겠습니다.</p>
<h2 id="첫-번째-환경-Google-Cloud-Build">첫 번째 환경: Google Cloud Build</h2>
<p>첫 번째로 구성해볼 환경은 GitHub 와 Google Cloud Build 를 이용한 구성입니다.</p>
<p><img src="github-cloudbuild.png" alt="GitHub 와 Cloud Build 를 이용한 CI/CD 구성"></p>
<ol>
<li>개발자가 코드를 작성하고 GitHub 으로 푸시합니다.</li>
<li>코드가 변경될 때마다 GitHub 와 연동된 Cloud Build 트리거가 실행됩니다.</li>
<li><code>cloudbuild.yaml</code> 에 정의된 빌드 작업을 수행합니다.</li>
<li>빌드 결과 생성된 도커 이미지를 컨테이너 레지스트리에 푸시합니다.</li>
<li>이미지를 GKE 클러스터에 배포합니다.</li>
</ol>
<h3 id="1-GitHub-저장소-준비하기">1. GitHub 저장소 준비하기</h3>
<p>먼저 코드를 저장할 GitHub 부터 준비합시다.</p>
<p>GitHub에 새로운 저장소를 생성합니다.<br>
<img src="create-github-repository.png" alt="GitHub 저장소 생성하기"></p>
<p>소스에서 Git 을 초기화합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> /home/vagrant/hello/.git/</span><br></pre></td></tr></table></figure>
<p>새로 만든 저장소를 remote 저장소로 추가합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin https://github.com/futureCreator/spring-boot-container.git</span><br></pre></td></tr></table></figure>
<p>저장소의 내용을 커밋하고 푸시합니다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;# spring-boot-container&quot; &gt;&gt; README.md</span><br><span class="line">git add .</span><br><span class="line">git commit -m &quot;first commit&quot;</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>
<p>코드는 모두 준비됐습니다.</p>
<h3 id="2-트리거-생성하기">2. 트리거 생성하기</h3>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://cloud.google.com/cloud-build/?hl=ko">Google Cloud Build</a>는 따로 빌드 환경을 구축할 필요 없이 간단하게 빌드할 수 있고, 구글의 서비스와 쉽게 통합할 수 있는 빌드 서비스입니다. GitHub와 연동해서 소스가 변경될 때 빌드를 트리거해서 시작하고, 빌드 과정을 <code>cloudbuild.yaml</code>에 정의하면 자동으로 빌드가 생성됩니다.</p>
<p>이후 실습에서 GCP 를 사용하면서 요금이 발생할 수 있습니다. GCP 는 가입 시 1년 동안 사용할 수 있는 $300 크레딧을 제공하므로 실습에는 큰 문제가 없을 겁니다. 회원 가입 후 새로운 프로젝트를 생성합니다.</p>
<p>GCP 는 사용하고자 하는 서비스의 API를 미리 활성화해야 합니다. API 매니저로 접속해서 Cloud Build API, Kubernetes Engine API, Container Registry API 등 실습하면서 필요할 때마다 해당 API 를 활성화하면 됩니다.</p>
<p>이제 빌드 트리거를 생성해봅시다. 먼저 GCP 검색 창에 ‘Cloud 빌드’를 검색하고 트리거 메뉴로 들어갑니다. <strong>트리거 만들기</strong>를 누르고 <strong>GitHub</strong> 를 선택합니다. 인증을 하면 해당 계정의 저장소가 나타나는데 위에서 만든 저장소를 선택합니다.</p>
<p>그리고 다음과 같이 트리거를 생성합니다. <code>cloudbuild.yaml</code> 파일로 빌드를 설정할 겁니다.</p>
<p><img src="cloud-build-trigger.png" alt="빌드 트리거 생성하기"></p>
<p>이제 모든 브랜치에 푸시될 경우 해당 트리거가 실행됩니다. 물론 콘솔에서 직접 수동으로 실행할 수도 있고 터미널에서 실행할 수도 있습니다.</p>
<h3 id="3-빌드하기">3. 빌드하기</h3>
<p>이제 빌드 작업을 <code>cloudbuild.yaml</code>에 작성할 차례입니다.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/mvn&#x27;</span></span><br><span class="line">  <span class="attr">args:</span> [<span class="string">&#x27;install&#x27;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/docker&#x27;</span></span><br><span class="line">  <span class="attr">args:</span> [<span class="string">&#x27;build&#x27;</span>, <span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;gcr.io/spring-boot-container/spring-boot-container-test&#x27;</span>, <span class="string">&#x27;.&#x27;</span>]</span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">500s</span></span><br><span class="line"><span class="attr">options:</span></span><br><span class="line">  <span class="attr">machineType:</span> <span class="string">&#x27;N1_HIGHCPU_8&#x27;</span> <span class="comment"># HIGHCPU로 빌드 스피드 업</span></span><br><span class="line"><span class="attr">timeout:</span> <span class="string">1000s</span> <span class="comment"># 빌드 자체에 대한 타임 아웃</span></span><br></pre></td></tr></table></figure>
<ul>
<li>각 스텝의 <code>name</code>은 빌드에 사용하는 이미지를 나타냅니다(cloud-builders). 해당 이미지의 컨테이너에서 빌드가 수행됩니다.</li>
<li>먼저 <code>mvn</code> 이미지에서 <code>install</code> 작업이 수행되고 <code>docker</code> 이미지에서 빌드를 수행합니다.</li>
</ul>
<p>파일을 생성하고 푸시하면 트리거가 작동해서 빌드가 수행됩니다.</p>
<p><img src="build-phase.png" alt="Cloud Build 결과"></p>
<h3 id="4-Container-Registry-에-이미지-푸시하기">4. Container Registry 에 이미지 푸시하기</h3>
<p>컨테이너의 장점 중 하나는 해당 이미지를 재활용할 수 있다는 점입니다. 자주 사용하는 이미지를 저장해놓고 언제든 내려받아 컨테이너로 실행할 수 있습니다. 이러한 이미지 저장소를 Docker Registry 또는 Container Registry 라고 합니다. Docker Hub 는 도커에서 운영하는 대표적인 컨테이너 레지스트리입니다.</p>
<p>이 외에도 클라우드 프로바이더는 private한 레지스트리를 제공합니다. AWS 의 Elastic Container Registry, GCP 의 Google Container Registry 가 있습니다. 이러한 레지스트리는 취약점 스캔, 위험한 이미지 자동 잠금, 자사 서비스와의 통합 등 부가 기능을 제공합니다. 특히 컨테이너는 애플리케이션과 환경을 함께 저장하므로 보안에 취약한데 이를 보완해주는 기능을 제공합니다.</p>
<p>Container Registry 를 사용하는 방법은 간단합니다. 위에서 본 것처럼 도커 이미지 빌드 시에 <code>[HOSTNAME]/[PROJECT-ID]/[IMAGE]:[TAG]</code> 형태로 태그를 달게 되는데요, 기본적으로 도커 허브(<code>docker.io</code>)가 적용됩니다. 우리는 Google Container Registry 에 맞는 태그를 달고 푸시해주면 됩니다.</p>
<p><code>cloudbuild.yaml</code> 해당 작업을 추가합시다.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/mvn&#x27;</span></span><br><span class="line">  <span class="attr">args:</span> [<span class="string">&#x27;install&#x27;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/docker&#x27;</span></span><br><span class="line">  <span class="attr">args:</span> [<span class="string">&#x27;build&#x27;</span>, <span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;gcr.io/spring-boot-container/spring-boot-container-test&#x27;</span>, <span class="string">&#x27;.&#x27;</span>]</span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">500s</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/docker&#x27;</span></span><br><span class="line">  <span class="attr">args:</span> [<span class="string">&#x27;push&#x27;</span>, <span class="string">&#x27;gcr.io/spring-boot-container/spring-boot-container-test&#x27;</span>]</span><br><span class="line"><span class="attr">options:</span></span><br><span class="line">  <span class="attr">machineType:</span> <span class="string">&#x27;N1_HIGHCPU_8&#x27;</span> <span class="comment"># HIGHCPU로 빌드 스피드 업</span></span><br><span class="line"><span class="attr">timeout:</span> <span class="string">1000s</span> <span class="comment"># 빌드 자체에 대한 타임 아웃</span></span><br></pre></td></tr></table></figure>
<ul>
<li>도커 빌드 시 태그명의 <code>gcr.io</code> 가 바로 Google Container Registry 입니다.</li>
<li><code>docker push</code> 를 하면 해당 태그에 맞춰서 저장소에 추가됩니다.</li>
</ul>
<p>빌드 작업 후 컨테이너 이미지가 추가된 것을 확인할 수 있습니다. 새로운 이미지는 <code>latest</code> 라는 태그가 자동으로 추가됩니다.</p>
<p><img src="container-registry-image.png" alt="컨테이너 이미지가 추가된 모습"></p>
<h3 id="5-Kubernetes-Engine-에-배포하기">5. Kubernetes Engine 에 배포하기</h3>
<p>지금까지 지속적인 통합(Continuous Integration) 환경을 구축했고 지속적인 배포(Continuous Deployment) 환경을 구축해봅시다.</p>
<p>빌드한 이미지를 쿠버네티스 클러스터에 Deployment 오브젝트로 배포합니다. 쿠버네티스의 Deployment 는 컨테이너 단위인 Pod 과 컨테이너의 개수를 유지해주는 ReplicaSet 을 포함하고, 배포 시 롤링 업데이트<sup id="fnref:1"><a href="#fn:1" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="롤링 업데이트(Rolling Update)란 기존 서비스를 유지하면서 업데이트하기 위한 방법으로, 여러 개의 인스턴스가 있을 때 하나씩 새로운 버전의 인스턴스로 교체하는 방법입니다.
">[1]</span></a></sup> 을 지원합니다. 또한 Deployment 를 노출(expose)해서 외부에서 접근하는 서비스를 생성할 수 있습니다.</p>
<p>콘솔에서 GKE에 접속해 <strong>작업부하</strong> 메뉴에서 <strong>배포</strong>를 클릭해 새로운 배포를 생성합니다.</p>
<p><strong>Google Container Registry 이미지 선택</strong>을 클릭해 빌드한 이미지를 선택하고 <strong>완료</strong>를 클릭해 컨테이너를 추가합니다.</p>
<p>추가 정보를 작성합니다. 클러스터는 기존 클러스터를 생성해도 되지만 새로운 클러스터를 생성하겠습니다.<br>
<img src="create-k8s-deployment.png" alt="클러스터 정보"></p>
<p>클러스터가 생성되길 기다리면서 IAM에 권한을 추가합시다. Cloud Build의 서비스 계정이 클러스터에 접근해야 하므로 역할(권한)을 추가해줘야 합니다. <strong>IAM 및 관리자</strong> 메뉴에서 <strong>Cloud 빌드 서비스 계정</strong>의 권한에 <strong>Kubernetes Engine 관리자</strong> 역할을 추가합니다.<br>
<img src="iam-cloud-build-role.png" alt="Kubernetes Engine 관리자 역할 추가"></p>
<p><code>cloudbuild.yaml</code> 에 배포 작업을 추가합시다.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/mvn&#x27;</span></span><br><span class="line">  <span class="attr">args:</span> [<span class="string">&#x27;install&#x27;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/docker&#x27;</span></span><br><span class="line">  <span class="attr">args:</span> [<span class="string">&#x27;build&#x27;</span>, <span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;gcr.io/spring-boot-container/spring-boot-container-test&#x27;</span>, <span class="string">&#x27;.&#x27;</span>]</span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">500s</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/docker&#x27;</span></span><br><span class="line">  <span class="attr">args:</span> [<span class="string">&#x27;push&#x27;</span>, <span class="string">&#x27;gcr.io/spring-boot-container/spring-boot-container-test&#x27;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;gcr.io/cloud-builders/kubectl&#x27;</span></span><br><span class="line">  <span class="attr">args:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">set</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">image</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deployment/spring-boot-container</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">spring-boot-container-test=gcr.io/spring-boot-container/spring-boot-container-test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">-n</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">spring-boot</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;CLOUDSDK_COMPUTE_ZONE=us-central1-a&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;CLOUDSDK_CONTAINER_CLUSTER=spring-boot-container-cluster&#x27;</span></span><br><span class="line"><span class="attr">options:</span></span><br><span class="line">  <span class="attr">machineType:</span> <span class="string">&#x27;N1_HIGHCPU_8&#x27;</span> <span class="comment"># HIGHCPU로 빌드 스피드 업</span></span><br><span class="line"><span class="attr">timeout:</span> <span class="string">1000s</span> <span class="comment"># 빌드 자체에 대한 타임 아웃</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>kubectl set image</code> 명령어를 이용해 컨테이너 이미지를 변경합니다.</li>
<li><code>CLOUDSDK_COMPUTE_ZONE</code>: 클러스터를 생성한 지역입니다.</li>
<li><code>CLOUDSDK_CONTAINER_CLUSTER</code>: 생성한 클러스터명입니다.</li>
<li><code>-n spring-boot</code>: 해당 Deployment 가 있는 namespace 를 지정합니다.</li>
</ul>
<p>이제 빌드 후 이미지가 새로 생성되면, 클러스터에서 새로운 이미지를 기반으로 Pod 이 새로 생성됩니다.<br>
<img src="cloud-build-result.png" alt="빌드 및 배포 결과"></p>
<p>새로운 이미지가 배포되어 Pod이 새로 생성된 것을 볼 수 있습니다.<br>
<img src="kubectl-deploy-result.png" alt="배포 결과 확인"></p>
<p>첫 번째 환경으로 GitHub와 Cloud Build를 이용해서 배포하는 환경을 구축해봤습니다. 각 단계별로 수정해볼만한 항목입니다.</p>
<ul>
<li>GitHub와 연동한 저장소는 Google Code Source Repository 에서도 확인할 수 있습니다. 물론 GitHub 대신 여기서 저장소를 생성해서 사용할 수도 있습니다.</li>
<li><code>cloudbuild.yaml</code> 에서 빌드 작업을 정의했습니다. 빌드 작업을 하나의 YAML 파일로 관리할 수 있어 편리했습니다. 메이븐 빌드는 <code>Dockerfile</code> 에서 수행하도록 수정할 수도 있습니다.</li>
<li>컨테이너 레지스트리는 다른 레지스트리를 사용할 수도 있지만 GCP 서비스와 연동이 잘 되는 Google Container Registry를 사용했습니다. 또한 취약점 검사를 적용해볼 수도 있고, 해당 이미지를 공개하면 다른 곳에서도 사용할 수 있습니다.</li>
<li>GKE는 쿠버네티스에 친숙하지 않더라도 쉽게 사용할 수 있도록 웹 UI에서 다양한 기능을 제공하고 있습니다. 이 외에도 Deployment 를 노출해 서비스를 만들 수도 있습니다.</li>
<li>빌드 과정에서 <code>mvn test</code> 를 수행하며 단위 테스트를 수행합니다. 실운영 환경에서는 빌드 과정에서 빌드 및 통합 테스트 스텝을 추가하는 것이 좋습니다.</li>
</ul>
<h2 id="두-번째-환경-GitLab-GKE">두 번째 환경: GitLab + GKE</h2>
<p>이번에는 GitLab 위주의 환경을 구성해보겠습니다.</p>
<p><img src="gitlab-cicd.png" alt="GitLab 과 GKE 를 이용한 CI/CD 구성"></p>
<p>GitLab은 GitHub에 비해 많이 사용되진 않지만 상당히 유용한 도구입니다. GitHub 처럼 다른 도구와 연동을 많이 제공하진 않지만 GitLab 자체에서 CI/CD 기능을 지원하고 Container Registry 도 지원합니다. 또한 GKE 와 연동해 클러스터의 상태를 바로 확인할 수 있습니다. 코드 저장소에서 빌드 파이프라인과 배포 상태까지 확인하는 것은 상당히 유용합니다.</p>
<h3 id="1-GitLab-저장소-준비하기">1. GitLab 저장소 준비하기</h3>
<p>두 번째 환경은 대부분 GitLab에서 지원하는 기능을 사용하기 때문에 설정이 더 간단합니다.</p>
<p>GitLab 저장소를 새로 만듭니다. 그리고 위에서 사용한 소스에 origin 을 새로 추가하고 푸시합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote add gitlab_origin https://gitlab.com/futureCreator/spring-boot-container.git</span><br><span class="line">git push -u gitlab_origin master</span><br></pre></td></tr></table></figure>
<p>저장소는 간단하게 준비했습니다.</p>
<h3 id="2-메이븐-빌드하기">2. 메이븐 빌드하기</h3>
<p>먼저 메이븐 빌드를 먼저 정의합니다.</p>
<p>코드를 푸시하면 GitLab 대시보드에서 다음과 같은 화면을 볼 수 있습니다.<br>
<img src="gitlab-dashboard.png" alt="GitLab 대시보드"></p>
<p><strong>Set up CI/CD</strong> 를 클릭하면 <code>.gitlab-cicd.yml</code> 파일을 작성하는 화면으로 넘어갑니다. 위에서 작성한 <code>cloudbuild.yaml</code> 처럼 빌드 작업을 정의하는 파일입니다. 해당 파일을 작성하면 자동으로 CI/CD 가 적용됩니다.<sup id="fnref:2"><a href="#fn:2" rel="footnote"><span class="hint--top hint--error hint--medium hint--rounded hint--bounce" aria-label="빌드 설정이 친숙하지 않은 개발자를 위해 사전에 정의된 CI/CD 설정으로 빌드 작업을 자동화하는 [Auto DevOps](https://about.gitlab.com/product/auto-devops/)라는 기능도 있습니다. `Auto Build`, `Auto Test`, `Auto Deploy` 등 기능을 제공합니다. GitLab 11.3부터 모든 프로젝트에 Auto DevOps가 기본적으로 설정되어 있어 코드를 처음 올리면 파이프라인 작업이 수행됩니다. 물론 완벽히 구성하지 않은 상태여서 첫 번째 파이프라인 작업이 실패한다면 해당 설정은 disabled 됩니다.">[2]</span></a></sup></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">docker:latest</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker:dind</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DOCKER_DRIVER:</span> <span class="string">overlay</span></span><br><span class="line">  <span class="attr">SPRING_PROFILES_ACTIVE:</span> <span class="string">gitlab-ci</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">package</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">maven-build:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">maven:3-jdk-8</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">&quot;mvn install&quot;</span></span><br><span class="line">  <span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">target/*.jar</span></span><br></pre></td></tr></table></figure>
<p>해당 커밋에 대해 빌드 파이프라인이 생성됩니다. <strong>CI/CD &gt; Pipeline</strong> 화면에서 파이프라인의 빌드와 잡을 확인할 수 있습니다.<br>
<img src="gitlab-maven-build.png" alt="GitLab 메이븐 빌드"></p>
<p><code>cloudbuild.yaml</code> 과 문법은 다르지만 어떤 내용인지는 쉽게 알아 볼 수 있습니다.</p>
<h3 id="3-도커-빌드하고-Container-Registry-에-푸시하기">3. 도커 빌드하고 Container Registry 에 푸시하기</h3>
<p>이번엔 도커 빌드 스테이지를 추가하고 GitLab 저장소에 자동으로 생성되는 컨테이너 레지스트리에 도커 이미지를 푸시하겠습니다.</p>
<p>컨테이너 레지스트리는 저장소의 <strong>Registry</strong> 메뉴에 있습니다. 간단한 사용법을 확인할 수 있습니다.</p>
<p><code>.gitlab-cicd.yml</code> 파일에 도커 빌드 작업을 추가합니다.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">docker:latest</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker:dind</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DOCKER_DRIVER:</span> <span class="string">overlay</span></span><br><span class="line">  <span class="attr">SPRING_PROFILES_ACTIVE:</span> <span class="string">gitlab-ci</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">package</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">maven-build:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">maven:3-jdk-8</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">&quot;mvn install&quot;</span></span><br><span class="line">  <span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">target/*.jar</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">docker-build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">package</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">registry.gitlab.com/futurecreator/spring-boot-container</span> <span class="string">.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">login</span> <span class="string">-u</span> <span class="string">gitlab-ci-token</span> <span class="string">-p</span> <span class="string">$CI_BUILD_TOKEN</span> <span class="string">registry.gitlab.com</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">registry.gitlab.com/futurecreator/spring-boot-container</span></span><br></pre></td></tr></table></figure>
<p>빌드 결과를 확인합니다.<br>
<img src="gitlab-docker-build.png" alt="GitLab 도커 빌드 결과"></p>
<p>컨테이너 레지스트리에서 빌드된 이미지를 확인할 수 있습니다.<br>
<img src="gitlab-registry-result.png" alt="컨테이너 레지스트리"></p>
<p>이제 코드가 변경될 때마다 빌드가 수행되고 이미지가 레지스트리에 추가됩니다.</p>
<h3 id="4-GKE-에-배포하기">4. GKE 에 배포하기</h3>
<p>마지막으로 쿠버네티스 클러스터에 배포할 차례입니다. 클러스터는 이전 실습에서 생성한 클러스터를 활용하면 되겠네요.</p>
<p>배포 과정 자체는 비슷하지만 GitLab 이 외부 서비스이다 보니 조금 더 손이 갑니다. cloud-sdk 로 클러스터에 접속하기 때문에 인증 절차가 필요합니다.</p>
<p>먼저 GCP의 <strong>IAM Service Account Credentials API &gt; 사용자 인증 정보</strong> 에서 서비스 계정의 키를 JSON 으로 생성합니다.<br>
<img src="create-key.png" alt="비공개 키 생성"></p>
<p>그러면 JSON Key를 자동으로 내려받습니다. 해당 JSON Key 내용을 복사해서 GitLab 의 <strong>Settings &gt; CI/CD &gt; Environment variables</strong> 에 <code>GOOGLE_KEY</code> 로 추가합니다.</p>
<p>클러스터에서 사전 작업을 합시다. 먼저 해당 애플리케이션을 배포할 네임스페이스를 생성합니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace spring-boot-2</span><br></pre></td></tr></table></figure>
<p>GitLab 레지스트리에서 이미지를 받아오기 위한 계정 정보를 Secret 객체로 만들어야 합니다. 각 값은 여러분의 계정으로 작성하면 됩니다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry registry.gitlab.com --docker-server=https://registry.gitlab.com --docker-username=yourusername --docker-password=yourpassword --docker-email=youremail -n spring-boot-2</span><br></pre></td></tr></table></figure>
<p>이제 배포를 합시다. 첫 번째 환경을 구성할 때는 미리 배포가 되어 있어서 배포된 이미지를 교체하는 <code>kubectl set image</code> 명령어를 사용했습니다. 이번에는 변경 사항을 파일로 적용하는 <code>kubectl apply -f</code> 명령어를 이용하기 위해 소스 폴더 루트에 <code>deployment.yaml</code> 파일을 추가합니다.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">spring-boot-container</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">spring-boot-2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">spring-boot-container</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">spring-boot-container</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">spring-boot-container</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">spring-boot-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">registry.gitlab.com/futurecreator/spring-boot-container</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registry.gitlab.com</span></span><br></pre></td></tr></table></figure>
<ul>
<li>내용을 살펴보면 첫 번째 환경의 배포 YAML 과 비슷합니다.</li>
<li>다른 점은 배포할 네임스페이스, 이미지, 그리고 이미지를 내려받을 때 사용할 <code>imagePullSecrets</code> 설정입니다.</li>
</ul>
<p>이제 <code>.gitlab-cicd.yml</code> 파일에 배포 과정을 추가합니다.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">docker:latest</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker:dind</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DOCKER_DRIVER:</span> <span class="string">overlay</span></span><br><span class="line">  <span class="attr">SPRING_PROFILES_ACTIVE:</span> <span class="string">gitlab-ci</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">package</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">maven-build:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">maven:3-jdk-8</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">&quot;mvn install&quot;</span></span><br><span class="line">  <span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">target/*.jar</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">docker-build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">package</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">registry.gitlab.com/futurecreator/spring-boot-container</span> <span class="string">.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">login</span> <span class="string">-u</span> <span class="string">gitlab-ci-token</span> <span class="string">-p</span> <span class="string">$CI_BUILD_TOKEN</span> <span class="string">registry.gitlab.com</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">registry.gitlab.com/futurecreator/spring-boot-container</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">k8s-deploy:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">google/cloud-sdk</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;$GOOGLE_KEY&quot;</span> <span class="string">&gt;</span> <span class="string">key.json</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gcloud</span> <span class="string">auth</span> <span class="string">activate-service-account</span> <span class="string">--key-file</span> <span class="string">key.json</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gcloud</span> <span class="string">config</span> <span class="string">set</span> <span class="string">compute/zone</span> <span class="string">us-central1-a</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gcloud</span> <span class="string">config</span> <span class="string">set</span> <span class="string">project</span> <span class="string">spring-boot-container</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gcloud</span> <span class="string">container</span> <span class="string">clusters</span> <span class="string">get-credentials</span> <span class="string">spring-boot-container-cluster</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">deployment.yaml</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>gcloud</code> 를 이용해 클러스터에 접속합니다. 접속이 안될 경우 <code>GOOGLE_KEY</code>, 프로젝트명, 지역, 클러스터 이름 등 접속 정보를 확인합니다.</li>
<li>우리가 작성한 <code>deployment.yaml</code> 을 이용해 변경 사항을 배포합니다.</li>
</ul>
<p>빌드 결과를 확인합니다.<br>
<img src="gitlab-gke-deploy-result.png" alt="GitLab 빌드 결과 확인"></p>
<p>클러스터에 접속해 배포 결과를 확인합니다.<br>
<img src="gitlab-gke-deploy-kubectl.png" alt="GKE 배포 결과 확인"></p>
<p>이번에는 GitLab 의 서비스를 주로 이용해서 CI/CD  환경을 구성했습니다. Cloud Build 와 비교했을 때 서비스가 무료이고 GitLab 안에서 대부분 해결할 수 있다는 장점이 있습니다(물론 GitLab 도 특정 서비스는 유료입니다). 또한 해당 서비스를 시각적으로 파이프라인으로 볼 수 있는 것도 장점입니다.</p>
<h2 id="정리">정리</h2>
<p>이번 포스트에서는 간단한 스프링부트 애플리케이션을 작성해서 컨테이너로 만들고 CI/CD 환경을 구성했습니다. 코드가 수정될 때마다 빌드하고 원하는 환경에 배포까지 쉽게 할 수 있었습니다. 기존에 많이 사용하는 Jenkins 는 별도의 서버를 구성하거나 쿠버네티스 클러스터에 별도의 컨테이너를 띄워야 합니다. 그래서 최대한 쉽게 접근해서 구성할 수 있는 환경 위주로 실습했습니다.</p>
<p>실습에 사용한 코드는 다음 저장소에서 확인할 수 있습니다.</p>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/futureCreator/spring-boot-container">https://github.com/futureCreator/spring-boot-container</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://gitlab.com/futureCreator/spring-boot-container">https://gitlab.com/futureCreator/spring-boot-container</a></li>
</ul>
<h2 id="참고">참고</h2>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://spring.io/blog/2018/11/08/spring-boot-in-a-container">Spring Boot in Conatiner | Spring.io</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://cloud.google.com/cloud-build/docs/">Google Cloud Build Docs | Google Cloud Platform</a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.gitlab.com/ee/ci/">GItLab Continuous Intergration (GitLab CI/CD) | GitLab Docs</a></li>
</ul>
<h2 id="Related-Posts">Related Posts</h2>
<ul>
<li>
<a href="/2018/11/16/docker-container-basics/" title="도커 Docker 기초 확실히 다지기">도커 Docker 기초 확실히 다지기</a>
</li>
<li>
<a href="/2018/11/09/it-infrastructure-basics/" title="개발자를 위한 인프라 기초 총정리">개발자를 위한 인프라 기초 총정리</a>
</li>
<li>
<a href="/2018/07/04/aws-certified/" title="AWS 자격증 준비하기">AWS 자격증 준비하기</a>
</li>
<li>
<a href="/2018/12/15/aws-reinvent-2018-summary/" title="AWS re:Invent 2018 한 방에 정리하기">AWS re:Invent 2018 한 방에 정리하기</a>
</li>
<li>
<a href="/2019/02/25/kubernetes-cluster-on-google-compute-engine-for-developers/" title="개발자를 위한 쿠버네티스(Kubernetes) 클러스터 구성하기(Kubeadm, GCE, CentOS)">개발자를 위한 쿠버네티스(Kubernetes) 클러스터 구성하기(Kubeadm, GCE, CentOS)</a>
</li>
</ul>
<div id="footnotes"><hr><div id="footnotelist"><ol style="list-style: none; padding-left: 0; margin-left: 40px"><li id="fn:1"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">1.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">롤링 업데이트(Rolling Update)란 기존 서비스를 유지하면서 업데이트하기 위한 방법으로, 여러 개의 인스턴스가 있을 때 하나씩 새로운 버전의 인스턴스로 교체하는 방법입니다.<a href="#fnref:1" rev="footnote"> ↩</a></span></li><li id="fn:2"><span style="display: inline-block; vertical-align: top; padding-right: 10px; margin-left: -40px">2.</span><span style="display: inline-block; vertical-align: top; margin-left: 10px;">빌드 설정이 친숙하지 않은 개발자를 위해 사전에 정의된 CI/CD 설정으로 빌드 작업을 자동화하는 <a target="_blank" rel="external nofollow noopener noreferrer" href="https://about.gitlab.com/product/auto-devops/">Auto DevOps</a>라는 기능도 있습니다. <code>Auto Build</code>, <code>Auto Test</code>, <code>Auto Deploy</code> 등 기능을 제공합니다. GitLab 11.3부터 모든 프로젝트에 Auto DevOps가 기본적으로 설정되어 있어 코드를 처음 올리면 파이프라인 작업이 수행됩니다. 물론 완벽히 구성하지 않은 상태여서 첫 번째 파이프라인 작업이 실패한다면 해당 설정은 disabled 됩니다.<a href="#fnref:2" rev="footnote"> ↩</a></span></li></ol></div></div>
        </div>
        <footer class="article-footer">
          


    <div class="a2a_kit a2a_default_style">
    <a class="a2a_dd" target="_blank" rel="external nofollow noopener noreferrer" href="https://www.addtoany.com/share">Share</a>
    <span class="a2a_divider"></span>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_google_plus"></a>
    <a class="a2a_button_pinterest"></a>
    <a class="a2a_button_tumblr"></a>
</div>
<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>


        </footer>
  </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="linkedin-square" href="https://kr.linkedin.com/in/dongho-han-97465327" target="_blank" rel="external nofollow noopener noreferrer">
                        <i class="icon fa fa-linkedin-square"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/futureCreator" target="_blank" rel="external nofollow noopener noreferrer">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/feed.xml" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    <script src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script>
    
        
<nav id="article-nav">
    
        <a href="/2019/02/25/kubernetes-cluster-on-google-compute-engine-for-developers/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            개발자를 위한 쿠버네티스(Kubernetes) 클러스터 구성하기(Kubeadm, GCE, CentOS)
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2018/12/15/aws-reinvent-2018-summary/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">AWS re:Invent 2018 한 방에 정리하기</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">March 2025</a><span class="archive-list-count">23</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">February 2024</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">19</span></li></ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <!-- <img src="/images/logo/writer/xingkai.png"> -->
                <p>&copy; 2025 Eric Han</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'futurecreator';
    
    
    var disqus_url = 'https://futurecreator.github.io/2019/01/19/spring-boot-containerization-and-ci-cd-to-kubernetes-cluster/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>





<script src="/vendor/fancybox/jquery.fancybox.pack.js"></script>




<script src="/vendor/scrollLoading/jquery.scrollLoading.js"></script>


<script src="/vendor/scrollLoading/main.js"></script>




<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>
</body>
</html>
